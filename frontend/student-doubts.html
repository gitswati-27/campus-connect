<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ask Doubts</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 20px; }
    form { background: white; padding: 20px; border-radius: 10px; max-width: 500px; margin: auto; }
    textarea, select, button { width: 100%; margin: 10px 0; padding: 10px; }
    .doubt { background: white; padding: 15px; border-radius: 8px; margin: 15px 0; }
  </style>
</head>
<body>
  <h2>Ask a Doubt</h2>
  <form id="doubtForm">
    <textarea id="question" placeholder="Type your doubt here..." required></textarea>
    <select id="facultySelect" required>
      <option value="">-- Select Faculty --</option>
    </select>
    <button type="submit">Submit Doubt</button>
  </form>

  <h2>Your Doubts</h2>
  <div id="doubts"></div>

  <button id="logoutBtn">Logout</button>

  <script>
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user'));

    if (!user || user.role !== 'student') {
      window.location.href = 'login.html';
    }

    // Load faculty list
    async function loadFaculty() {
      const res = await fetch('http://localhost:3000/api/doubts/faculty', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const facultyList = await res.json();
      const select = document.getElementById('facultySelect');

      facultyList.forEach(f => {
        const option = document.createElement('option');
        option.value = f._id;
        option.textContent = `${f.name} (${f.regNo})`;
        select.appendChild(option);
      });
    }

    // Submit doubt
    document.getElementById('doubtForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const question = document.getElementById('question').value;
      const assignedFaculty = document.getElementById('facultySelect').value;

      const res = await fetch('http://localhost:3000/api/doubts', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ question, assignedFaculty })
      });

      if (res.ok) {
        document.getElementById('doubtForm').reset();
        loadDoubts(); // refresh
      } else {
        alert("Error submitting doubt");
      }
    });

    // Load student's own doubts
    async function loadDoubts() {
      const res = await fetch('http://localhost:3000/api/doubts', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const doubts = await res.json();

      const container = document.getElementById('doubts');
      container.innerHTML = '';

      doubts
        .filter(d => d.student?._id === user.id) // only show own doubts
        .forEach(d => {
          const div = document.createElement('div');
          div.classList.add('doubt');
          div.innerHTML = `
            <p><strong>Q:</strong> ${d.question}</p>
            <p><em>To: ${d.assignedFaculty?.name || "Unknown Faculty"}</em></p>
            <p><strong>Answer:</strong> ${d.answer || '<em>Not answered yet</em>'}</p>
          `;
          container.appendChild(div);
        });
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.clear();
      window.location.href = 'login.html';
    });

    loadFaculty();
    loadDoubts();
  </script>
</body>
</html>
